"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var router_1 = require("@angular/router");
var rss_service_1 = require("../../../shared/services/rss.service");
var entities_1 = require("../../../shared/entities/entities");
var app = require("tns-core-modules/application");
var router_2 = require("@angular/router");
//https://github.com/bradmartin/nativescript-audio
var timer = require("timer");
var nativescript_audio_1 = require("nativescript-audio");
var page_1 = require("ui/page");
var RssDetailComponent = (function () {
    function RssDetailComponent(router, activatedRoute, rssService, page) {
        var _this = this;
        this.router = router;
        this.activatedRoute = activatedRoute;
        this.rssService = rssService;
        this.page = page;
        this.loaded = false;
        this.pageLoaded = false;
        this.progressValue = 0;
        this._player = new nativescript_audio_1.TNSPlayer();
        this.currentTime_s = '0:00';
        this.platform = app.android ? 'android' : 'ios';
        this.showType = 'scripture';
        this.audioInitiated = false;
        this.showPlayBtn = 'hidden';
        this.customItem = new entities_1.CustomItem();
        var __this = this;
        this.page.on(page_1.Page.navigatingToEvent, function () {
            __this._updateRssItem();
        });
        setTimeout(function () {
            _this.activatedRoute.params
                .forEach(function (params) {
                _this.rssType = params['rssType'];
                _this.rssItemIndex = params['index'];
                console.log('indetail page: ', _this.rssType, _this.rssItemIndex);
                _this.rssService.retrieveRssItemFor(_this.rssType, _this.rssItemIndex, function (item) {
                    console.log('item is:');
                    _this.item = item;
                    //now, let's fetch custom note
                    _this.rssService.getNotedItemFor(item.uuid, function (customItems) {
                        if (customItems.length > 0) {
                            _this.customItem = customItems[0];
                        }
                    });
                    _this.pageLoaded = true;
                    _this._player.initFromUrl({
                        audioFile: _this.item.enclosure_link,
                        loop: false,
                        completeCallback: _this._trackComplete.bind(_this),
                        errorCallback: _this._trackError.bind(_this),
                        infoCallback: _this._infoCallback.bind(_this)
                    }).then(function () {
                        _this._player.getAudioTrackDuration().then(function (duration) {
                            _this._player.volume = 1;
                            // iOS: duration is in seconds
                            // Android: duration is in milliseconds
                            var duration_i = parseInt(duration);
                            if (_this.platform == 'android') {
                                duration_i = duration_i / 1000;
                            }
                            _this.totalLength = duration_i;
                            _this.totalLength_s = _this._convertTS(duration_i);
                            _this.loaded = true;
                            _this.showPlayBtn = 'visible';
                            _this.timerId = timer.setInterval(function () {
                                var currentTime = Math.floor(_this._player.currentTime);
                                if (_this.platform == 'android') {
                                    currentTime = currentTime / 1000;
                                }
                                console.log(currentTime + ' --- ' + _this.totalLength);
                                if (currentTime < _this.totalLength - 1) {
                                    console.log('pos 1 ');
                                    _this.currentTime = currentTime;
                                    _this.currentTime_s = _this._convertTS(currentTime);
                                    _this.progressValue = (_this.currentTime / _this.totalLength) * 100;
                                }
                                else {
                                    console.log(' pos 2 ');
                                    //timer.clearInterval(this.timerId);
                                    // this._player.seekTo(0);
                                    // this._player.pause();
                                    _this.btnTitle = _this.rssService.trans("Start", "开始");
                                }
                            }, 1000);
                            _this.audioInitiated = true;
                        });
                    });
                });
            });
        }, 0);
        this.btnTitle = this.rssService.trans("Start", "开始");
    }
    RssDetailComponent.prototype._updateRssItem = function () {
        var _this = this;
        //now, let's fetch custom note
        if (this.item) {
            this.rssService.getNotedItemFor(this.item.uuid, function (customItems) {
                if (customItems.length > 0) {
                    _this.customItem = customItems[0];
                }
            });
        }
    };
    RssDetailComponent.prototype.ngOnDestroy = function () {
        timer.clearInterval(this.timerId);
        if (this.audioInitiated) {
            console.log('distroy the player');
            this._player.dispose();
            this._player = null;
        }
    };
    RssDetailComponent.prototype.togglePlay = function () {
        if (this._player.isAudioPlaying()) {
            this._player.pause();
            this.btnTitle = this.rssService.trans("Resume", "重新开始");
        }
        else {
            this._player.play();
            this.btnTitle = this.rssService.trans("Pause", "暂停");
        }
    };
    RssDetailComponent.prototype.show = function (showType) {
        this.showType = showType;
    };
    RssDetailComponent.prototype.addNote = function () {
        console.log('adding note');
        // let index = this.listViewComponent.listView.items.indexOf(args.object.bindingContext);
        // let uuid = this.rssItems[index].uuid;
        this.rssService.setItem(this.item);
        this.router.navigate(['rssnote']);
    };
    RssDetailComponent.prototype._convertTS = function (s) {
        s = Math.floor(s);
        var resultM = Math.floor(s / 60);
        var resultS = s - resultM * 60;
        return resultM + ":" + (resultS > 10 ? '' : '0') + resultS;
    };
    RssDetailComponent.prototype.onSliderValueChange = function (args) {
        var slider = args.object;
        console.log('value changed -->');
        //this._player.seekTo( this.totalLength*slider.value/100 );
    };
    RssDetailComponent.prototype._infoCallback = function (args) {
    };
    RssDetailComponent.prototype._trackComplete = function (args) {
        var _this = this;
        console.log('reference back to player:', args.player);
        // iOS only: flag indicating if completed succesfully
        console.log('whether song play completed successfully:', args.flag);
        this._player.dispose().then(function () {
            _this._player.seekTo(0);
            _this._player.pause();
            _this.btnTitle = _this.rssService.trans("Start", "开始");
        });
    };
    RssDetailComponent.prototype._trackError = function (args) {
        console.log('reference back to player:', args.player);
        console.log('the error:', args.error);
        // Android only: extra detail on error
        console.log('extra info on the error:', args.extra);
    };
    RssDetailComponent.prototype.trans = function (en, zh) {
        return this.rssService.trans(en, zh);
    };
    RssDetailComponent = __decorate([
        core_1.Component({
            moduleId: module.id,
            styleUrls: ['./detail.component.css', './detail.css'],
            templateUrl: './detail.component.html'
        }),
        __metadata("design:paramtypes", [router_2.Router,
            router_1.ActivatedRoute,
            rss_service_1.RssService,
            page_1.Page])
    ], RssDetailComponent);
    return RssDetailComponent;
}());
exports.RssDetailComponent = RssDetailComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV0YWlsLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRldGFpbC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBd0M7QUFDeEMsMENBQWlEO0FBQ2pELG9FQUFnRTtBQUNoRSw4REFBaUY7QUFDakYsa0RBQW9EO0FBRXBELDBDQUF1QztBQUV2QyxrREFBa0Q7QUFDbEQsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBRTdCLHlEQUErQztBQUUvQyxnQ0FBNkI7QUFTN0I7SUE0QkksNEJBQW9CLE1BQWMsRUFDdEIsY0FBOEIsRUFDOUIsVUFBc0IsRUFDdEIsSUFBUztRQUhyQixpQkF1R0s7UUF2R2UsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUN0QixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFDOUIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN0QixTQUFJLEdBQUosSUFBSSxDQUFLO1FBRWIsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7UUFDcEIsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7UUFFeEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUM7UUFDdkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLDhCQUFTLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsYUFBYSxHQUFHLE1BQU0sQ0FBQztRQUM1QixJQUFJLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxPQUFPLEdBQUcsU0FBUyxHQUFHLEtBQUssQ0FBQztRQUVoRCxJQUFJLENBQUMsUUFBUSxHQUFHLFdBQVcsQ0FBQztRQUU1QixJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FBQztRQUM1QixJQUFJLENBQUMsV0FBVyxHQUFHLFFBQVEsQ0FBQztRQUM1QixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUkscUJBQVUsRUFBRSxDQUFDO1FBRW5DLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQztR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TCxJQTJOSztBQTNOUSxnREFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvbmVudH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7UnNzU2VydmljZX0gZnJvbSBcIi4uLy4uLy4uL3NoYXJlZC9zZXJ2aWNlcy9yc3Muc2VydmljZVwiO1xuaW1wb3J0IHtSc3MsIENoYW5uZWwsIEl0ZW0sIEN1c3RvbUl0ZW19IGZyb20gJy4uLy4uLy4uL3NoYXJlZC9lbnRpdGllcy9lbnRpdGllcyc7XG5pbXBvcnQgKiBhcyBhcHAgZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvYXBwbGljYXRpb25cIjtcbmltcG9ydCB7IFNsaWRlciB9IGZyb20gXCJ1aS9zbGlkZXJcIjtcbmltcG9ydCB7Um91dGVyfSBmcm9tIFwiQGFuZ3VsYXIvcm91dGVyXCI7XG5cbi8vaHR0cHM6Ly9naXRodWIuY29tL2JyYWRtYXJ0aW4vbmF0aXZlc2NyaXB0LWF1ZGlvXG52YXIgdGltZXIgPSByZXF1aXJlKFwidGltZXJcIik7XG5cbmltcG9ydCB7IFROU1BsYXllciB9IGZyb20gJ25hdGl2ZXNjcmlwdC1hdWRpbyc7XG5pbXBvcnQgeyBQcm9ncmVzcyB9IGZyb20gXCJ1aS9wcm9ncmVzc1wiO1xuaW1wb3J0IHtQYWdlfSBmcm9tICd1aS9wYWdlJztcblxuaW1wb3J0ICogYXMgaHRtbFZpZXdNb2R1bGUgZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdWkvaHRtbC12aWV3XCI7XG5cbkBDb21wb25lbnQoe1xuICAgIG1vZHVsZUlkOiBtb2R1bGUuaWQsXG4gICAgc3R5bGVVcmxzOiBbJy4vZGV0YWlsLmNvbXBvbmVudC5jc3MnLCAnLi9kZXRhaWwuY3NzJ10sXG4gICAgdGVtcGxhdGVVcmw6ICcuL2RldGFpbC5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgUnNzRGV0YWlsQ29tcG9uZW50IHtcblxuICAgIHJzc1R5cGU6IHN0cmluZztcbiAgICByc3NJdGVtSW5kZXg6IG51bWJlcjtcbiAgICBpdGVtOiBJdGVtO1xuICAgIHRvdGFsTGVuZ3RoOiBudW1iZXI7XG4gICAgY3VycmVudFRpbWU6IG51bWJlcjtcbiAgICB0b3RhbExlbmd0aF9zOiBzdHJpbmc7XG4gICAgY3VycmVudFRpbWVfczogc3RyaW5nO1xuXG4gICAgcGxhdGZvcm06IHN0cmluZztcblxuICAgIHByaXZhdGUgX3BsYXllcjogVE5TUGxheWVyO1xuICAgIGJ0blRpdGxlOiBzdHJpbmc7XG4gICAgbG9hZGVkOiBib29sZWFuO1xuICAgIHRpbWVySWQ7XG4gICAgYXVkaW9Jbml0aWF0ZWQ6IGJvb2xlYW47XG4gICAgc2hvd1BsYXlCdG46IHN0cmluZztcbiAgICBwdWJsaWMgcHJvZ3Jlc3NWYWx1ZTogbnVtYmVyO1xuICAgIGN1c3RvbUl0ZW06Q3VzdG9tSXRlbTtcblxuXG4gICAgc2hvd1R5cGU6IHN0cmluZztcblxuICAgIGxhc3RDaGFuZ2VUUzpudW1iZXI7XG5cbiAgICBwYWdlTG9hZGVkOiBib29sZWFuO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICAgICAgcHJpdmF0ZSBhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsXG4gICAgICAgIHByaXZhdGUgcnNzU2VydmljZTogUnNzU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBwYWdlOlBhZ2UpIHtcblxuICAgICAgICAgICAgdGhpcy5sb2FkZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMucGFnZUxvYWRlZCA9IGZhbHNlO1xuXG4gICAgICAgICAgICB0aGlzLnByb2dyZXNzVmFsdWUgPSAwO1xuICAgICAgICAgICAgdGhpcy5fcGxheWVyID0gbmV3IFROU1BsYXllcigpO1xuICAgICAgICAgICAgdGhpcy5jdXJyZW50VGltZV9zID0gJzA6MDAnO1xuICAgICAgICAgICAgdGhpcy5wbGF0Zm9ybSA9IGFwcC5hbmRyb2lkID8gJ2FuZHJvaWQnIDogJ2lvcyc7XG5cbiAgICAgICAgICAgIHRoaXMuc2hvd1R5cGUgPSAnc2NyaXB0dXJlJztcblxuICAgICAgICAgICAgdGhpcy5hdWRpb0luaXRpYXRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5zaG93UGxheUJ0biA9ICdoaWRkZW4nO1xuICAgICAgICAgICAgdGhpcy5jdXN0b21JdGVtID0gbmV3IEN1c3RvbUl0ZW0oKTtcblxuICAgICAgICAgICAgdmFyIF9fdGhpcyA9IHRoaXM7XG4gICAgICAgICAgICB0aGlzLnBhZ2Uub24oUGFnZS5uYXZpZ2F0aW5nVG9FdmVudCwgZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICBfX3RoaXMuX3VwZGF0ZVJzc0l0ZW0oKTtcbiAgICAgICAgICAgIH0pO1xuXG5cbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PntcbiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2YXRlZFJvdXRlLnBhcmFtc1xuICAgICAgICAgICAgICAgIC5mb3JFYWNoKChwYXJhbXMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yc3NUeXBlID0gcGFyYW1zWydyc3NUeXBlJ107XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucnNzSXRlbUluZGV4ID0gcGFyYW1zWydpbmRleCddO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyggJ2luZGV0YWlsIHBhZ2U6ICcsIHRoaXMucnNzVHlwZSwgdGhpcy5yc3NJdGVtSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJzc1NlcnZpY2UucmV0cmlldmVSc3NJdGVtRm9yKHRoaXMucnNzVHlwZSwgdGhpcy5yc3NJdGVtSW5kZXgsIGl0ZW0gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2l0ZW0gaXM6Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW0gPSBpdGVtO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvL25vdywgbGV0J3MgZmV0Y2ggY3VzdG9tIG5vdGVcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucnNzU2VydmljZS5nZXROb3RlZEl0ZW1Gb3IoaXRlbS51dWlkLCBjdXN0b21JdGVtcz0+e1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGN1c3RvbUl0ZW1zLmxlbmd0aD4wKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXN0b21JdGVtID0gY3VzdG9tSXRlbXNbMF07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFnZUxvYWRlZCA9IHRydWU7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BsYXllci5pbml0RnJvbVVybCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9GaWxlOiB0aGlzLml0ZW0uZW5jbG9zdXJlX2xpbmssXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9vcDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tcGxldGVDYWxsYmFjazogdGhpcy5fdHJhY2tDb21wbGV0ZS5iaW5kKHRoaXMpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yQ2FsbGJhY2s6IHRoaXMuX3RyYWNrRXJyb3IuYmluZCh0aGlzKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmZvQ2FsbGJhY2s6IHRoaXMuX2luZm9DYWxsYmFjay5iaW5kKHRoaXMpXG4gICAgICAgICAgICAgICAgICAgICAgICB9KS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wbGF5ZXIuZ2V0QXVkaW9UcmFja0R1cmF0aW9uKCkudGhlbigoZHVyYXRpb24pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGxheWVyLnZvbHVtZSA9IDE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGlPUzogZHVyYXRpb24gaXMgaW4gc2Vjb25kc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBBbmRyb2lkOiBkdXJhdGlvbiBpcyBpbiBtaWxsaXNlY29uZHNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGR1cmF0aW9uX2k6IG51bWJlciA9IHBhcnNlSW50KGR1cmF0aW9uKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wbGF0Zm9ybSA9PSAnYW5kcm9pZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uX2kgPSBkdXJhdGlvbl9pIC8gMTAwMDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudG90YWxMZW5ndGggPSBkdXJhdGlvbl9pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRvdGFsTGVuZ3RoX3MgPSB0aGlzLl9jb252ZXJ0VFMoZHVyYXRpb25faSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3dQbGF5QnRuID0gJ3Zpc2libGUnO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGltZXJJZCA9IHRpbWVyLnNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50VGltZTogbnVtYmVyID0gTWF0aC5mbG9vcih0aGlzLl9wbGF5ZXIuY3VycmVudFRpbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGxhdGZvcm0gPT0gJ2FuZHJvaWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFRpbWUgPSBjdXJyZW50VGltZSAvIDEwMDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhjdXJyZW50VGltZSsnIC0tLSAnK3RoaXMudG90YWxMZW5ndGgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUaW1lIDwgdGhpcy50b3RhbExlbmd0aC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ3BvcyAxICcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFRpbWUgPSBjdXJyZW50VGltZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRUaW1lX3MgPSB0aGlzLl9jb252ZXJ0VFMoY3VycmVudFRpbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJvZ3Jlc3NWYWx1ZSA9ICh0aGlzLmN1cnJlbnRUaW1lIC8gdGhpcy50b3RhbExlbmd0aCkgKiAxMDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCcgcG9zIDIgJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy90aW1lci5jbGVhckludGVydmFsKHRoaXMudGltZXJJZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5fcGxheWVyLnNlZWtUbygwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLl9wbGF5ZXIucGF1c2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJ0blRpdGxlID0gdGhpcy5yc3NTZXJ2aWNlLnRyYW5zKFwiU3RhcnRcIiwgXCLlvIDlp4tcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAxMDAwKTtcblxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9Jbml0aWF0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG5cblxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LCAwKTtcblxuXG5cblxuICAgICAgICAgICAgdGhpcy5idG5UaXRsZSA9IHRoaXMucnNzU2VydmljZS50cmFucyhcIlN0YXJ0XCIsIFwi5byA5aeLXCIpO1xuICAgICAgICB9XG5cbiAgICAgICAgX3VwZGF0ZVJzc0l0ZW0oKXtcbiAgICAgICAgICAgIC8vbm93LCBsZXQncyBmZXRjaCBjdXN0b20gbm90ZVxuICAgICAgICAgICAgaWYodGhpcy5pdGVtKXtcbiAgICAgICAgICAgICAgICB0aGlzLnJzc1NlcnZpY2UuZ2V0Tm90ZWRJdGVtRm9yKHRoaXMuaXRlbS51dWlkLCBjdXN0b21JdGVtcz0+e1xuICAgICAgICAgICAgICAgICAgICBpZihjdXN0b21JdGVtcy5sZW5ndGg+MCl7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN1c3RvbUl0ZW0gPSBjdXN0b21JdGVtc1swXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgbmdPbkRlc3Ryb3koKSB7XG4gICAgICAgICAgICB0aW1lci5jbGVhckludGVydmFsKHRoaXMudGltZXJJZCk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvSW5pdGlhdGVkKXtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZGlzdHJveSB0aGUgcGxheWVyJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5fcGxheWVyLmRpc3Bvc2UoKTtcbiAgICAgICAgICAgICAgICB0aGlzLl9wbGF5ZXIgPSBudWxsO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICB0b2dnbGVQbGF5KCkge1xuICAgICAgICAgICAgaWYgKHRoaXMuX3BsYXllci5pc0F1ZGlvUGxheWluZygpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcGxheWVyLnBhdXNlKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5idG5UaXRsZSA9IHRoaXMucnNzU2VydmljZS50cmFucyhcIlJlc3VtZVwiLCBcIumHjeaWsOW8gOWni1wiKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcGxheWVyLnBsYXkoKTtcbiAgICAgICAgICAgICAgICB0aGlzLmJ0blRpdGxlID0gdGhpcy5yc3NTZXJ2aWNlLnRyYW5zKFwiUGF1c2VcIiwgXCLmmoLlgZxcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBzaG93KHNob3dUeXBlOiBzdHJpbmcpIHtcbiAgICAgICAgICAgIHRoaXMuc2hvd1R5cGUgPSBzaG93VHlwZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGFkZE5vdGUoKXtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdhZGRpbmcgbm90ZScpO1xuXG4gICAgICAgICAgICAvLyBsZXQgaW5kZXggPSB0aGlzLmxpc3RWaWV3Q29tcG9uZW50Lmxpc3RWaWV3Lml0ZW1zLmluZGV4T2YoYXJncy5vYmplY3QuYmluZGluZ0NvbnRleHQpO1xuICAgICAgICAgICAgLy8gbGV0IHV1aWQgPSB0aGlzLnJzc0l0ZW1zW2luZGV4XS51dWlkO1xuICAgICAgICAgICAgdGhpcy5yc3NTZXJ2aWNlLnNldEl0ZW0odGhpcy5pdGVtKTtcbiAgICAgICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsncnNzbm90ZSddKTtcbiAgICAgICAgfVxuXG4gICAgICAgIF9jb252ZXJ0VFMoczogbnVtYmVyKSB7XG4gICAgICAgICAgICBzID0gTWF0aC5mbG9vcihzKTtcbiAgICAgICAgICAgIHZhciByZXN1bHRNID0gTWF0aC5mbG9vcihzIC8gNjApO1xuICAgICAgICAgICAgdmFyIHJlc3VsdFMgPSBzIC0gcmVzdWx0TSAqIDYwO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdE0gKyBcIjpcIiArIChyZXN1bHRTID4gMTAgPyAnJyA6ICcwJykgKyByZXN1bHRTO1xuICAgICAgICB9XG5cbiAgICAgICAgcHVibGljIG9uU2xpZGVyVmFsdWVDaGFuZ2UoYXJncykge1xuICAgICAgICAgICAgbGV0IHNsaWRlciA9IDxTbGlkZXI+YXJncy5vYmplY3Q7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygndmFsdWUgY2hhbmdlZCAtLT4nKTtcbiAgICAgICAgICAgIC8vdGhpcy5fcGxheWVyLnNlZWtUbyggdGhpcy50b3RhbExlbmd0aCpzbGlkZXIudmFsdWUvMTAwICk7XG4gICAgICAgIH1cblxuICAgICAgICBwcml2YXRlIF9pbmZvQ2FsbGJhY2soYXJnczogYW55KSB7XG4gICAgICAgIH1cblxuICAgICAgICBwcml2YXRlIF90cmFja0NvbXBsZXRlKGFyZ3M6IGFueSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ3JlZmVyZW5jZSBiYWNrIHRvIHBsYXllcjonLCBhcmdzLnBsYXllcik7XG4gICAgICAgICAgICAvLyBpT1Mgb25seTogZmxhZyBpbmRpY2F0aW5nIGlmIGNvbXBsZXRlZCBzdWNjZXNmdWxseVxuICAgICAgICAgICAgY29uc29sZS5sb2coJ3doZXRoZXIgc29uZyBwbGF5IGNvbXBsZXRlZCBzdWNjZXNzZnVsbHk6JywgYXJncy5mbGFnKTtcbiAgICAgICAgICAgIHRoaXMuX3BsYXllci5kaXNwb3NlKCkudGhlbihcbiAgICAgICAgICAgICAgICAoKT0+e1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9wbGF5ZXIuc2Vla1RvKDApO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9wbGF5ZXIucGF1c2UoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5idG5UaXRsZSA9IHRoaXMucnNzU2VydmljZS50cmFucyhcIlN0YXJ0XCIsIFwi5byA5aeLXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcHJpdmF0ZSBfdHJhY2tFcnJvcihhcmdzOiBhbnkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdyZWZlcmVuY2UgYmFjayB0byBwbGF5ZXI6JywgYXJncy5wbGF5ZXIpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ3RoZSBlcnJvcjonLCBhcmdzLmVycm9yKTtcblxuICAgICAgICAgICAgLy8gQW5kcm9pZCBvbmx5OiBleHRyYSBkZXRhaWwgb24gZXJyb3JcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdleHRyYSBpbmZvIG9uIHRoZSBlcnJvcjonLCBhcmdzLmV4dHJhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyYW5zKGVuLCB6aCl7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yc3NTZXJ2aWNlLnRyYW5zKGVuLCB6aCk7XG4gICAgICAgIH1cblxuXG4gICAgfVxuIl19