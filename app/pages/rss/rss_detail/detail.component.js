"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var router_1 = require("@angular/router");
var rss_service_1 = require("../../../shared/services/rss.service");
var entities_1 = require("../../../shared/entities/entities");
var app = require("tns-core-modules/application");
var router_2 = require("@angular/router");
//https://github.com/bradmartin/nativescript-audio
var timer = require("timer");
var nativescript_audio_1 = require("nativescript-audio");
var page_1 = require("ui/page");
// //Below is used for ios background running mode
var setCategoryRes = AVAudioSession.sharedInstance().setCategoryWithOptionsError(AVAudioSessionCategoryPlayAndRecord, AVAudioSessionCategoryOptions.DefaultToSpeaker);
var detail_service_1 = require("./detail.service");
var RssDetailComponent = (function () {
    function RssDetailComponent(router, activatedRoute, rssService, page, detailService) {
        var _this = this;
        this.router = router;
        this.activatedRoute = activatedRoute;
        this.rssService = rssService;
        this.page = page;
        this.detailService = detailService;
        this.loaded = false;
        this.pageLoaded = false;
        this.progressValue = 0;
        this._player = new nativescript_audio_1.TNSPlayer();
        this.currentTime_s = '0:00';
        this.platform = app.android ? 'android' : 'ios';
        this.showType = 'scripture';
        this.audioInitiated = false;
        this.showPlayBtn = 'hidden';
        this.customItem = new entities_1.CustomItem();
        var __this = this;
        this.page.on(page_1.Page.navigatingToEvent, function () {
            __this._updateRssItem();
        });
        setTimeout(function () {
            _this.activatedRoute.params
                .forEach(function (params) {
                _this.rssType = params['rssType'];
                _this.rssItemIndex = params['index'];
                console.log('indetail page: ', _this.rssType, _this.rssItemIndex);
                _this.rssService.retrieveRssItemFor(_this.rssType, _this.rssItemIndex, function (item) {
                    _this.item = item;
                    //now, let's fetch custom note
                    _this.rssService.getNotedItemFor(item.uuid, function (customItems) {
                        if (customItems.length > 0) {
                            _this.customItem = customItems[0];
                        }
                    });
                    _this.pageLoaded = true;
                    _this._initPlayer();
                });
            });
        }, 0);
    }
    RssDetailComponent.prototype._initPlayer = function () {
        var _this = this;
        this._player.initFromUrl({
            audioFile: this.item.enclosure_link,
            loop: false,
            completeCallback: this._trackComplete.bind(this),
            errorCallback: this._trackError.bind(this),
            infoCallback: this._infoCallback.bind(this)
        }).then(function () {
            _this._player.getAudioTrackDuration().then(function (duration) {
                _this._player.volume = 1;
                // iOS: duration is in seconds
                // Android: duration is in milliseconds
                var duration_i = parseInt(duration);
                if (_this.platform == 'android') {
                    duration_i = duration_i / 1000;
                }
                _this.totalLength = duration_i;
                _this.totalLength_s = _this._convertTS(duration_i);
                _this.loaded = true;
                _this.showPlayBtn = 'visible';
                _this.detailService.onInterval(function () {
                    var currentTime = 0;
                    if (_this._player) {
                        currentTime = Math.floor(_this._player.currentTime);
                    }
                    if (_this.platform == 'android') {
                        currentTime = currentTime / 1000;
                    }
                    _this.currentTime = currentTime;
                    _this.currentTime_s = _this._convertTS(currentTime);
                    _this.progressValue = (_this.currentTime / _this.totalLength) * 100;
                    console.log('curentTime', _this.currentTime, 'progressValue', _this.progressValue);
                });
                _this.audioInitiated = true;
            });
        });
        this.btnTitle = this.rssService.trans("Start", "开始");
    };
    RssDetailComponent.prototype._updateRssItem = function () {
        var _this = this;
        //now, let's fetch custom note
        if (this.item) {
            this.rssService.getNotedItemFor(this.item.uuid, function (customItems) {
                if (customItems.length > 0) {
                    _this.customItem = customItems[0];
                }
            });
        }
    };
    RssDetailComponent.prototype.ngOnDestroy = function () {
        this.detailService.clearInterval();
        if (this.audioInitiated) {
            console.log('distroy the player');
            this._player.dispose();
            this._player = null;
        }
    };
    RssDetailComponent.prototype.unLoaded = function () {
        console.log('player.component unloaded');
    };
    RssDetailComponent.prototype.togglePlay = function () {
        if (this._player.isAudioPlaying()) {
            this._player.pause();
            this.btnTitle = this.rssService.trans("Resume", "重新开始");
        }
        else {
            this._player.play();
            this.btnTitle = this.rssService.trans("Pause", "暂停");
        }
    };
    RssDetailComponent.prototype.show = function (showType) {
        this.showType = showType;
    };
    RssDetailComponent.prototype.addNote = function () {
        console.log('adding note');
        // let index = this.listViewComponent.listView.items.indexOf(args.object.bindingContext);
        // let uuid = this.rssItems[index].uuid;
        this.rssService.setItem(this.item);
        this.router.navigate(['rssnote']);
    };
    RssDetailComponent.prototype._convertTS = function (s) {
        s = Math.floor(s);
        var resultM = Math.floor(s / 60);
        var resultS = s - resultM * 60;
        return resultM + ":" + (resultS > 10 ? '' : '0') + resultS;
    };
    RssDetailComponent.prototype.onSliderValueChange = function (args) {
        var slider = args.object;
        var seekValue = slider.value;
        var dif = 1;
        var progressValue = this.progressValue;
        //android is in milliseconds
        if (this.platform == 'android') {
            seekValue = seekValue * 1000;
            progressValue = progressValue * 1000;
            dif = dif * 1000;
        }
        if (Math.abs(seekValue - progressValue) > dif) {
            this._player.seekTo(this.totalLength * seekValue / 100);
        }
    };
    RssDetailComponent.prototype._infoCallback = function (args) {
    };
    RssDetailComponent.prototype._trackComplete = function (args) {
        var _this = this;
        console.log('reference back to player:', args.player);
        // iOS only: flag indicating if completed succesfully
        console.log('whether song play completed successfully:', args.flag);
        this._player.dispose().then(function () {
            _this._initPlayer();
        });
    };
    RssDetailComponent.prototype._trackError = function (args) {
        console.log('reference back to player:', args.player);
        console.log('the error:', args.error);
        // Android only: extra detail on error
        console.log('extra info on the error:', args.extra);
    };
    RssDetailComponent.prototype.trans = function (en, zh) {
        return this.rssService.trans(en, zh);
    };
    RssDetailComponent = __decorate([
        core_1.Component({
            moduleId: module.id,
            styleUrls: ['./detail.component.css', './detail.css'],
            templateUrl: './detail.component.html'
        }),
        __metadata("design:paramtypes", [router_2.Router,
            router_1.ActivatedRoute,
            rss_service_1.RssService,
            page_1.Page,
            detail_service_1.DetailService])
    ], RssDetailComponent);
    return RssDetailComponent;
}());
exports.RssDetailComponent = RssDetailComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV0YWlsLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRldGFpbC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBd0M7QUFDeEMsMENBQWlEO0FBQ2pELG9FQUFnRTtBQUNoRSw4REFBaUY7QUFDakYsa0RBQW9EO0FBRXBELDBDQUF1QztBQUV2QyxrREFBa0Q7QUFDbEQsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzdCLHlEQUErQztBQUUvQyxnQ0FBNkI7QUFLN0Isa0RBQWtEO0FBQ2xELElBQUksY0FBYyxHQUNkLGNBQWMsQ0FBQyxjQUFjLEVBQUUsQ0FBQywyQkFBMkIsQ0FBRSxtQ0FBbUMsRUFBRSw2QkFBNkIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBRXRKLG1EQUErQztBQU8vQztJQTZCSSw0QkFBb0IsTUFBYyxFQUN0QixjQUE4QixFQUM5QixVQUFzQixFQUN0QixJQUFTLEVBQ1QsYUFBMkI7UUFKdkMsaUJBOENLO1FBOUNlLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDdEIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDdEIsU0FBSSxHQUFKLElBQUksQ0FBSztRQUNULGtCQUFhLEdBQWIsYUFBYSxDQUFjO1FBRS9CLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBQ3BCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1FBRXhCLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSw4QkFBUyxFQUFFLENBQUM7UUFDL0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUM7UUFDNUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUMsT0FBTyxHQUFHLFNBQVMsR0FBRyxLQUFLLENBQUM7UUFFaEQsSUFBSSxDQUFDLFFBQVEsR0FB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SUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUF2Tkksa0JBQWtCO1FBTDlCLGdCQUFTLENBQUM7WUFDUCxRQUFRLEVBQUUsTUFBTSxDQUFDLEVBQUU7WUFDbkIsU0FBUyxFQUFFLENBQUMsd0JBQXdCLEVBQUUsY0FBYyxDQUFDO1lBQ3JELFdBQVcsRUFBRSx5QkFBeUI7U0FDekMsQ0FBQzt5Q0E4QjhCLGVBQU07WUFDTix1QkFBYztZQUNsQix3QkFBVTtZQUNqQixXQUFJO1lBQ0ssOEJBQWE7T0FqQzlCLGtCQUFrQixDQTBOMUI7SUFBRCx5QkFBQztDQUFBLEFBMU5MLElBME5LO0FBMU5RLGdEQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9uZW50fSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHtSc3NTZXJ2aWNlfSBmcm9tIFwiLi4vLi4vLi4vc2hhcmVkL3NlcnZpY2VzL3Jzcy5zZXJ2aWNlXCI7XG5pbXBvcnQge1JzcywgQ2hhbm5lbCwgSXRlbSwgQ3VzdG9tSXRlbX0gZnJvbSAnLi4vLi4vLi4vc2hhcmVkL2VudGl0aWVzL2VudGl0aWVzJztcbmltcG9ydCAqIGFzIGFwcCBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy9hcHBsaWNhdGlvblwiO1xuaW1wb3J0IHsgU2xpZGVyIH0gZnJvbSBcInVpL3NsaWRlclwiO1xuaW1wb3J0IHtSb3V0ZXJ9IGZyb20gXCJAYW5ndWxhci9yb3V0ZXJcIjtcblxuLy9odHRwczovL2dpdGh1Yi5jb20vYnJhZG1hcnRpbi9uYXRpdmVzY3JpcHQtYXVkaW9cbnZhciB0aW1lciA9IHJlcXVpcmUoXCJ0aW1lclwiKTtcbmltcG9ydCB7IFROU1BsYXllciB9IGZyb20gJ25hdGl2ZXNjcmlwdC1hdWRpbyc7XG5pbXBvcnQgeyBQcm9ncmVzcyB9IGZyb20gXCJ1aS9wcm9ncmVzc1wiO1xuaW1wb3J0IHtQYWdlfSBmcm9tICd1aS9wYWdlJztcblxuaW1wb3J0ICogYXMgaHRtbFZpZXdNb2R1bGUgZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdWkvaHRtbC12aWV3XCI7XG5cbmRlY2xhcmUgdmFyIEFWQXVkaW9TZXNzaW9uLCBBVkF1ZGlvU2Vzc2lvbkNhdGVnb3J5UGxheUFuZFJlY29yZCwgQVZBdWRpb1Nlc3Npb25DYXRlZ29yeU9wdGlvbnM7XG4vLyAvL0JlbG93IGlzIHVzZWQgZm9yIGlvcyBiYWNrZ3JvdW5kIHJ1bm5pbmcgbW9kZVxubGV0IHNldENhdGVnb3J5UmVzID1cbiAgICBBVkF1ZGlvU2Vzc2lvbi5zaGFyZWRJbnN0YW5jZSgpLnNldENhdGVnb3J5V2l0aE9wdGlvbnNFcnJvciggQVZBdWRpb1Nlc3Npb25DYXRlZ29yeVBsYXlBbmRSZWNvcmQsIEFWQXVkaW9TZXNzaW9uQ2F0ZWdvcnlPcHRpb25zLkRlZmF1bHRUb1NwZWFrZXIpO1xuXG5pbXBvcnQge0RldGFpbFNlcnZpY2V9IGZyb20gJy4vZGV0YWlsLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgICBtb2R1bGVJZDogbW9kdWxlLmlkLFxuICAgIHN0eWxlVXJsczogWycuL2RldGFpbC5jb21wb25lbnQuY3NzJywgJy4vZGV0YWlsLmNzcyddLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9kZXRhaWwuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFJzc0RldGFpbENvbXBvbmVudCB7XG5cbiAgICByc3NUeXBlOiBzdHJpbmc7XG4gICAgcnNzSXRlbUluZGV4OiBudW1iZXI7XG4gICAgaXRlbTogSXRlbTtcbiAgICB0b3RhbExlbmd0aDogbnVtYmVyO1xuICAgIGN1cnJlbnRUaW1lOiBudW1iZXI7XG4gICAgdG90YWxMZW5ndGhfczogc3RyaW5nO1xuICAgIGN1cnJlbnRUaW1lX3M6IHN0cmluZztcblxuICAgIHBsYXRmb3JtOiBzdHJpbmc7XG5cbiAgICBwcml2YXRlIF9wbGF5ZXI6IFROU1BsYXllcjtcbiAgICBidG5UaXRsZTogc3RyaW5nO1xuICAgIGxvYWRlZDogYm9vbGVhbjtcbiAgICB0aW1lcklkO1xuICAgIGF1ZGlvSW5pdGlhdGVkOiBib29sZWFuO1xuICAgIHNob3dQbGF5QnRuOiBzdHJpbmc7XG4gICAgcHVibGljIHByb2dyZXNzVmFsdWU6IG51bWJlcjtcbiAgICBjdXN0b21JdGVtOkN1c3RvbUl0ZW07XG5cblxuICAgIHNob3dUeXBlOiBzdHJpbmc7XG5cbiAgICBsYXN0Q2hhbmdlVFM6bnVtYmVyO1xuXG4gICAgcGFnZUxvYWRlZDogYm9vbGVhbjtcbiAgICBwYXJlbnQ6IG51bGw7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgICAgICBwcml2YXRlIGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSxcbiAgICAgICAgcHJpdmF0ZSByc3NTZXJ2aWNlOiBSc3NTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHBhZ2U6UGFnZSxcbiAgICAgICAgcHJpdmF0ZSBkZXRhaWxTZXJ2aWNlOkRldGFpbFNlcnZpY2UpIHtcblxuICAgICAgICAgICAgdGhpcy5sb2FkZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMucGFnZUxvYWRlZCA9IGZhbHNlO1xuXG4gICAgICAgICAgICB0aGlzLnByb2dyZXNzVmFsdWUgPSAwO1xuICAgICAgICAgICAgdGhpcy5fcGxheWVyID0gbmV3IFROU1BsYXllcigpO1xuICAgICAgICAgICAgdGhpcy5jdXJyZW50VGltZV9zID0gJzA6MDAnO1xuICAgICAgICAgICAgdGhpcy5wbGF0Zm9ybSA9IGFwcC5hbmRyb2lkID8gJ2FuZHJvaWQnIDogJ2lvcyc7XG5cbiAgICAgICAgICAgIHRoaXMuc2hvd1R5cGUgPSAnc2NyaXB0dXJlJztcblxuICAgICAgICAgICAgdGhpcy5hdWRpb0luaXRpYXRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5zaG93UGxheUJ0biA9ICdoaWRkZW4nO1xuICAgICAgICAgICAgdGhpcy5jdXN0b21JdGVtID0gbmV3IEN1c3RvbUl0ZW0oKTtcblxuICAgICAgICAgICAgdmFyIF9fdGhpcyA9IHRoaXM7XG4gICAgICAgICAgICB0aGlzLnBhZ2Uub24oUGFnZS5uYXZpZ2F0aW5nVG9FdmVudCwgZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICBfX3RoaXMuX3VwZGF0ZVJzc0l0ZW0oKTtcbiAgICAgICAgICAgIH0pO1xuXG5cbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCk9PntcbiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2YXRlZFJvdXRlLnBhcmFtc1xuICAgICAgICAgICAgICAgIC5mb3JFYWNoKChwYXJhbXMpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yc3NUeXBlID0gcGFyYW1zWydyc3NUeXBlJ107XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucnNzSXRlbUluZGV4ID0gcGFyYW1zWydpbmRleCddO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyggJ2luZGV0YWlsIHBhZ2U6ICcsIHRoaXMucnNzVHlwZSwgdGhpcy5yc3NJdGVtSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnJzc1NlcnZpY2UucmV0cmlldmVSc3NJdGVtRm9yKHRoaXMucnNzVHlwZSwgdGhpcy5yc3NJdGVtSW5kZXgsIGl0ZW0gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pdGVtID0gaXRlbTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vbm93LCBsZXQncyBmZXRjaCBjdXN0b20gbm90ZVxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yc3NTZXJ2aWNlLmdldE5vdGVkSXRlbUZvcihpdGVtLnV1aWQsIGN1c3RvbUl0ZW1zPT57XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoY3VzdG9tSXRlbXMubGVuZ3RoPjApe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN1c3RvbUl0ZW0gPSBjdXN0b21JdGVtc1swXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFnZUxvYWRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9pbml0UGxheWVyKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSwgMCk7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIF9pbml0UGxheWVyKCl7XG4gICAgICAgICAgICB0aGlzLl9wbGF5ZXIuaW5pdEZyb21Vcmwoe1xuICAgICAgICAgICAgICAgIGF1ZGlvRmlsZTogdGhpcy5pdGVtLmVuY2xvc3VyZV9saW5rLFxuICAgICAgICAgICAgICAgIGxvb3A6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGNvbXBsZXRlQ2FsbGJhY2s6IHRoaXMuX3RyYWNrQ29tcGxldGUuYmluZCh0aGlzKSxcbiAgICAgICAgICAgICAgICBlcnJvckNhbGxiYWNrOiB0aGlzLl90cmFja0Vycm9yLmJpbmQodGhpcyksXG4gICAgICAgICAgICAgICAgaW5mb0NhbGxiYWNrOiB0aGlzLl9pbmZvQ2FsbGJhY2suYmluZCh0aGlzKVxuICAgICAgICAgICAgfSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcGxheWVyLmdldEF1ZGlvVHJhY2tEdXJhdGlvbigpLnRoZW4oKGR1cmF0aW9uKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3BsYXllci52b2x1bWUgPSAxO1xuICAgICAgICAgICAgICAgICAgICAvLyBpT1M6IGR1cmF0aW9uIGlzIGluIHNlY29uZHNcbiAgICAgICAgICAgICAgICAgICAgLy8gQW5kcm9pZDogZHVyYXRpb24gaXMgaW4gbWlsbGlzZWNvbmRzXG4gICAgICAgICAgICAgICAgICAgIHZhciBkdXJhdGlvbl9pOiBudW1iZXIgPSBwYXJzZUludChkdXJhdGlvbik7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucGxhdGZvcm0gPT0gJ2FuZHJvaWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbl9pID0gZHVyYXRpb25faSAvIDEwMDA7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICB0aGlzLnRvdGFsTGVuZ3RoID0gZHVyYXRpb25faTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50b3RhbExlbmd0aF9zID0gdGhpcy5fY29udmVydFRTKGR1cmF0aW9uX2kpO1xuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93UGxheUJ0biA9ICd2aXNpYmxlJztcblxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRldGFpbFNlcnZpY2Uub25JbnRlcnZhbCgoKT0+e1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRUaW1lOiBudW1iZXIgPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5fcGxheWVyKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50VGltZSA9IE1hdGguZmxvb3IodGhpcy5fcGxheWVyLmN1cnJlbnRUaW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBsYXRmb3JtID09ICdhbmRyb2lkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUaW1lID0gY3VycmVudFRpbWUgLyAxMDAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50VGltZSA9IGN1cnJlbnRUaW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50VGltZV9zID0gdGhpcy5fY29udmVydFRTKGN1cnJlbnRUaW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJvZ3Jlc3NWYWx1ZSA9ICh0aGlzLmN1cnJlbnRUaW1lIC8gdGhpcy50b3RhbExlbmd0aCkgKiAxMDA7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnY3VyZW50VGltZScsIHRoaXMuY3VycmVudFRpbWUsICdwcm9ncmVzc1ZhbHVlJywgdGhpcy5wcm9ncmVzc1ZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9Jbml0aWF0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLmJ0blRpdGxlID0gdGhpcy5yc3NTZXJ2aWNlLnRyYW5zKFwiU3RhcnRcIiwgXCLlvIDlp4tcIik7XG4gICAgICAgIH1cblxuICAgICAgICBfdXBkYXRlUnNzSXRlbSgpe1xuICAgICAgICAgICAgLy9ub3csIGxldCdzIGZldGNoIGN1c3RvbSBub3RlXG4gICAgICAgICAgICBpZih0aGlzLml0ZW0pe1xuICAgICAgICAgICAgICAgIHRoaXMucnNzU2VydmljZS5nZXROb3RlZEl0ZW1Gb3IodGhpcy5pdGVtLnV1aWQsIGN1c3RvbUl0ZW1zPT57XG4gICAgICAgICAgICAgICAgICAgIGlmKGN1c3RvbUl0ZW1zLmxlbmd0aD4wKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3VzdG9tSXRlbSA9IGN1c3RvbUl0ZW1zWzBdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBuZ09uRGVzdHJveSgpIHtcbiAgICAgICAgICAgIHRoaXMuZGV0YWlsU2VydmljZS5jbGVhckludGVydmFsKCk7XG4gICAgICAgICAgICBpZiAodGhpcy5hdWRpb0luaXRpYXRlZCl7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2Rpc3Ryb3kgdGhlIHBsYXllcicpO1xuICAgICAgICAgICAgICAgIHRoaXMuX3BsYXllci5kaXNwb3NlKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5fcGxheWVyID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHB1YmxpYyB1bkxvYWRlZCgpe1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygncGxheWVyLmNvbXBvbmVudCB1bmxvYWRlZCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgdG9nZ2xlUGxheSgpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9wbGF5ZXIuaXNBdWRpb1BsYXlpbmcoKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX3BsYXllci5wYXVzZSgpO1xuICAgICAgICAgICAgICAgIHRoaXMuYnRuVGl0bGUgPSB0aGlzLnJzc1NlcnZpY2UudHJhbnMoXCJSZXN1bWVcIiwgXCLph43mlrDlvIDlp4tcIik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuX3BsYXllci5wbGF5KCk7XG4gICAgICAgICAgICAgICAgdGhpcy5idG5UaXRsZSA9IHRoaXMucnNzU2VydmljZS50cmFucyhcIlBhdXNlXCIsIFwi5pqC5YGcXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgc2hvdyhzaG93VHlwZTogc3RyaW5nKSB7XG4gICAgICAgICAgICB0aGlzLnNob3dUeXBlID0gc2hvd1R5cGU7XG4gICAgICAgIH1cblxuICAgICAgICBhZGROb3RlKCl7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnYWRkaW5nIG5vdGUnKTtcblxuICAgICAgICAgICAgLy8gbGV0IGluZGV4ID0gdGhpcy5saXN0Vmlld0NvbXBvbmVudC5saXN0Vmlldy5pdGVtcy5pbmRleE9mKGFyZ3Mub2JqZWN0LmJpbmRpbmdDb250ZXh0KTtcbiAgICAgICAgICAgIC8vIGxldCB1dWlkID0gdGhpcy5yc3NJdGVtc1tpbmRleF0udXVpZDtcbiAgICAgICAgICAgIHRoaXMucnNzU2VydmljZS5zZXRJdGVtKHRoaXMuaXRlbSk7XG4gICAgICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbJ3Jzc25vdGUnXSk7XG4gICAgICAgIH1cblxuICAgICAgICBfY29udmVydFRTKHM6IG51bWJlcikge1xuICAgICAgICAgICAgcyA9IE1hdGguZmxvb3Iocyk7XG4gICAgICAgICAgICB2YXIgcmVzdWx0TSA9IE1hdGguZmxvb3IocyAvIDYwKTtcbiAgICAgICAgICAgIHZhciByZXN1bHRTID0gcyAtIHJlc3VsdE0gKiA2MDtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHRNICsgXCI6XCIgKyAocmVzdWx0UyA+IDEwID8gJycgOiAnMCcpICsgcmVzdWx0UztcbiAgICAgICAgfVxuXG4gICAgICAgIHB1YmxpYyBvblNsaWRlclZhbHVlQ2hhbmdlKGFyZ3MpIHtcbiAgICAgICAgICAgIGxldCBzbGlkZXIgPSA8U2xpZGVyPmFyZ3Mub2JqZWN0O1xuICAgICAgICAgICAgbGV0IHNlZWtWYWx1ZSA9IHNsaWRlci52YWx1ZTtcbiAgICAgICAgICAgIGxldCBkaWYgPSAxO1xuICAgICAgICAgICAgbGV0IHByb2dyZXNzVmFsdWUgPSB0aGlzLnByb2dyZXNzVmFsdWU7XG4gICAgICAgICAgICAvL2FuZHJvaWQgaXMgaW4gbWlsbGlzZWNvbmRzXG4gICAgICAgICAgICBpZiAodGhpcy5wbGF0Zm9ybSA9PSAnYW5kcm9pZCcpIHtcbiAgICAgICAgICAgICAgICBzZWVrVmFsdWUgPSBzZWVrVmFsdWUqMTAwMDtcbiAgICAgICAgICAgICAgICBwcm9ncmVzc1ZhbHVlPXByb2dyZXNzVmFsdWUqMTAwMDtcbiAgICAgICAgICAgICAgICBkaWYgPSBkaWYgKjEwMDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiggTWF0aC5hYnMoc2Vla1ZhbHVlLXByb2dyZXNzVmFsdWUpPmRpZil7XG4gICAgICAgICAgICAgICAgdGhpcy5fcGxheWVyLnNlZWtUbyggdGhpcy50b3RhbExlbmd0aCpzZWVrVmFsdWUvMTAwICk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuXG4gICAgICAgIHByaXZhdGUgX2luZm9DYWxsYmFjayhhcmdzOiBhbnkpIHtcbiAgICAgICAgfVxuXG4gICAgICAgIHByaXZhdGUgX3RyYWNrQ29tcGxldGUoYXJnczogYW55KSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygncmVmZXJlbmNlIGJhY2sgdG8gcGxheWVyOicsIGFyZ3MucGxheWVyKTtcbiAgICAgICAgICAgIC8vIGlPUyBvbmx5OiBmbGFnIGluZGljYXRpbmcgaWYgY29tcGxldGVkIHN1Y2Nlc2Z1bGx5XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnd2hldGhlciBzb25nIHBsYXkgY29tcGxldGVkIHN1Y2Nlc3NmdWxseTonLCBhcmdzLmZsYWcpO1xuICAgICAgICAgICAgdGhpcy5fcGxheWVyLmRpc3Bvc2UoKS50aGVuKFxuICAgICAgICAgICAgICAgICgpPT57XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2luaXRQbGF5ZXIoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgcHJpdmF0ZSBfdHJhY2tFcnJvcihhcmdzOiBhbnkpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdyZWZlcmVuY2UgYmFjayB0byBwbGF5ZXI6JywgYXJncy5wbGF5ZXIpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ3RoZSBlcnJvcjonLCBhcmdzLmVycm9yKTtcblxuICAgICAgICAgICAgLy8gQW5kcm9pZCBvbmx5OiBleHRyYSBkZXRhaWwgb24gZXJyb3JcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdleHRyYSBpbmZvIG9uIHRoZSBlcnJvcjonLCBhcmdzLmV4dHJhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyYW5zKGVuLCB6aCl7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yc3NTZXJ2aWNlLnRyYW5zKGVuLCB6aCk7XG4gICAgICAgIH1cblxuXG4gICAgfVxuIl19